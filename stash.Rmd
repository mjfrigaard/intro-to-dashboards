
---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Recap of `ggplot2` 

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Recap of `ggplot2`

## In the previous lesson, we covered: 

### 1) The grammar of graphics

- `ggplot2` is a language of *layers*, organized linearly 

--

- `ggplot2`'s layers give us a "*linear ordering of phrases*" to build an infinite number of graphs "*which convey a gnarly network of ideas.*" 

--

- "**Infinitely extensible**"

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Recap of `ggplot2` (cont)

## In the previous lesson, we covered:

### 1) The grammar of graphics

### 2) Identifying graph aesthetics 

--

- position (`x` and `y`), size, color, shape, etc.

--

```{r graph-elements, echo=FALSE, out.width='100%', out.height='100%'}
knitr::include_graphics(path = "img/graph-elements.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Recap of `ggplot2` (cont)

## In the previous lesson, we covered:

### 1) The grammar of graphics

### 2) Identifying graph aesthetics

### 3) Recognizing and using `geoms`

--

- Scatter plot = `geom_point()`

--

- Box plot = `geom_boxplot()`

--

- Line graph = `geom_line()`  

--

- Bar graph = `geom_histogram()`, `geom_bar()`, `geom_col()`


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Recap of `ggplot2` (cont)

## In the previous lesson, we covered:

### 1) The grammar of graphics

### 2) Identifying graph aesthetics

### 3) Recognizing and using `geoms`

### 4) Labels and factes (exercises)

- **Build labels first!** 

--

- Facet for subplots of levels in a grouping variable


---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Before we start...  


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Things to consider (1)

--

### Recognize the needs of your audience 

#### *level of data literacy, subject matter expertise, etc.*

--

### Check and communicate data quality with stakeholders  

#### *let them know the good and the bad news*

--

### Identify the correct data visualization (based on the data)

#### *single variable, bivariate, and multivariate graphs*

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Things to consider (2)

<br>

### Incorporate feedback from stakeholders/audience into graphs  

#### *ask them to be part of the process

--

### Design visualizations with the appropriate detail and annotations

####  *inform (and do not mislead) the audience*


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Getting started 

### 1) Clearly define the question or problem

- Start with a general goal, broad question, or novel problem

- Move towards specific tasks 

--

### 2) Matching the measurements to metrics 

- *'Measurements'* are what we care about  

- *'Metrics'* are the available data

--

### 3) Is a data visualization the best choice?

- Not always...

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# COVID and Transportation Habits 


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 8% 94%
background-size: 8%

## Example: How has COVID changed our modes of transportation?

### What kind of measurements would these be?

***how are people traveling (walk, drive, etc.)***

--

### What would these data look like?

***what would the columns and rows look like?***

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Apple Mobility Data

## Fortunately, these data exist!

Apple released mobility data: 

https://covid19.apple.com/mobility

Import these data below: 

```{r import-AppleMobRaw}
AppleMobRaw <- readr::read_csv("https://bit.ly/36tTVpe")
```

*Use `Raw` as a prefix or suffix for data in it's most 'raw' state*

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# Raw Apple Mobility Data

```{r AppleMobRaw-View, eval=FALSE}
AppleMobRaw %>% View("Apple")
```


```{r apple-mob-view, echo=FALSE, out.width='95%', out.height='95%'}
knitr::include_graphics(path = "img/apple-mob-view.png")
```

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Wrangling Apple Mobility Data 

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Wrangling Apple Mobility Data

--

<br>

### What variables do we have? 

--

### How are these variables formatted? 

--

### How do we need to change them? 

--

#### *...with a focus on answering our question*



---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## View Apple Mobility Data (head)

```{r AppleMobRaw-head, eval=FALSE}
AppleMobRaw %>% head()
```

```{r AppleMobRaw-head-show, echo=FALSE}
rmarkdown::paged_table(AppleMobRaw %>% head())
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## View Apple Mobility Data (tail)

```{r AppleMobRaw-tail, eval=FALSE}
AppleMobRaw %>% tail()
```

```{r AppleMobRaw-tail-show, echo=FALSE}
rmarkdown::paged_table(AppleMobRaw %>% tail())
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Tidying Apple Mobility Data 

Tidy dates and mobility into `date` and `dir_request` ('relative usage of directions')

```{r tidying-no-show, eval=FALSE}
AppleMobRaw %>% 
  tidyr::pivot_longer(cols = -c(geo_type:country), 
    names_to = "date", values_to = "dir_request")
```

```{r tidying-show, echo=FALSE}
rmarkdown::paged_table(AppleMobRaw %>% 
  tidyr::pivot_longer(
    cols = -c(geo_type:country), 
    names_to = "date", 
    values_to = "dir_request"))
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Manipulate Apple Mobility Data

Remove missing values in `country` and `sub-region` and `clean_names()`

```{r wrangle-no-show, eval=FALSE}
AppleMobRaw %>% 
  tidyr::pivot_longer(cols = -c(geo_type:country), 
    names_to = "date", values_to = "dir_request") %>% 
  # remove missing country data
  dplyr::filter(!is.na(country) & !is.na(`sub-region`)) %>% 
  # clean names
  janitor::clean_names() %>% View("TidyApple")
```

```{r wrangle-show, echo=FALSE, eval=FALSE}
AppleMobRaw %>% 
  tidyr::pivot_longer(cols = -c(geo_type:country), 
    names_to = "date", values_to = "dir_request") %>% 
  # remove missing country data
  dplyr::filter(!is.na(country) & !is.na(`sub-region`)) %>% 
  # clean names
  janitor::clean_names() %>% View("TidyApple")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### New Tidy Apple Mobility Data!

```{r apple-tidy-view.png, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics(path = "img/apple-tidy-view.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Assign Apple Mobility Data to `TidyApple`

This looks good, so assign to `TidyApple`

```{r wrangle-assign-show, eval=FALSE}
AppleMobRaw %>% 
  tidyr::pivot_longer(cols = -c(geo_type:country), 
    names_to = "date", values_to = "dir_request") %>% 
  # remove missing country data
  dplyr::filter(!is.na(country) & !is.na(`sub-region`)) %>% 
  # clean names
  janitor::clean_names() -> TidyApple
```

```{r wrangle-assign-no-show, echo=FALSE}
AppleMobRaw %>% 
  tidyr::pivot_longer(cols = -c(geo_type:country), 
    names_to = "date", values_to = "dir_request") %>% 
  # remove missing country data
  dplyr::filter(!is.na(country) & !is.na(`sub-region`)) %>% 
  # clean names
  janitor::clean_names() -> TidyApple
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `TidyApple`: Format Variables

Our `TidyApple` data still needs some attention. 

```{r glimpse-TidyApple}
glimpse(TidyApple)
```

The `date` variable needs to be formatted as a `date`

```{r format-date}
TidyApple %>% 
  mutate(date = lubridate::ymd(date)) -> TidyApple
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `TidyApple`: Rename Variables

Let's rename `transportation_type` to `trans_type`

```{r rename}
TidyApple %>% 
  rename(trans_type = transportation_type) -> TidyApple
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `TidyApple`: Check Formatted Variables

Re-check `TidyApple` data.

```{r recheck-glimpse-TidyApple}
glimpse(TidyApple)
```

Now we can see `date` is formatted correctly

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `TidyApple`: Counting

> “*data science is mostly counting things*” - `tabyl` vignette

Count the `trans_type` variable with `dplyr::count()`

.pull-left[

<br>

```{r count}
TidyApple %>% 
  count(trans_type)
```

]

.pull-right[

*Add the `sort = TRUE` argument*

```{r count-sort}
TidyApple %>% 
  count(trans_type, sort = TRUE)
```

]

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Visualizing Variable Distributions

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## What kinds of question(s) do graphs like these answer?

### What does the distribution of direction requests look like?

What is the distribution of `dir_request`? We will explore this with a histogram.

### Labels!!

```{r lab_hist}
lab_hist <- labs(x = "Apple directions requests",
                 y = "Count",
     title = "Distribution of Direction Requests",
     subtitle = "source: https://covid19.apple.com/mobility")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 8% 95%
background-size: 8%

## Histogram = single variable distributions

Create a histogram of `dir_request` with the code below:

```{r geom-hist-no-show, eval=FALSE}
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request)) + #<<
  lab_hist
```

```{r geom-hist-1-show, echo=FALSE, out.height='60%', out.width='60%'}
knitr::include_graphics(path = "img/geom-hist-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Histograms: Changing the Y Axis

Fix the `y` axis numbers with help from the [`scales` package](https://scales.r-lib.org/)

```{r geom-hist-scales-show, eval=FALSE}
library(scales)
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request)) + 
  scale_y_continuous(labels = scales::comma) + #<<
  lab_hist
```

```{r geom-hist-scales, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(scales)
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request)) + 
  scale_y_continuous(labels = scales::comma) +
  lab_hist
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Histograms: Changing the Y Axis

<br>

```{r geom-hist-scales-1-show, echo=FALSE, out.height='90%', out.width='90%'}
knitr::include_graphics(path = "img/geom-hist-scales-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Changing Histogram Shape

Adjust the shape of the histogram with the `bins` argument

```{r bins-15-show, eval=FALSE}
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request), bins = 15) + #<<
  scale_y_continuous(labels = scales::comma) +
  lab_hist
```

```{r bins-15-no-show, include=FALSE}
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request), bins = 15) + 
  scale_y_continuous(labels = scales::comma) +
  lab_hist
```

```{r bins-15-no-show-1-show, echo=FALSE, out.height='75%', out.width='75%'}
knitr::include_graphics(path = "img/bins-15-no-show-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Changing Histogram Shape

Adjust the shape of the histogram with the `bins` argument

```{r bins-45-show, eval=FALSE}
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request), bins = 45) + #<<
  scale_y_continuous(labels = scales::comma) +
  lab_hist
```

```{r bins-45-no-show, include=FALSE}
TidyApple %>% ggplot() + 
  geom_histogram(aes(x = dir_request), bins = 45) + 
  scale_y_continuous(labels = scales::comma) +
  lab_hist
```

```{r bins-45-no-show-1-show, echo=FALSE, out.height='75%', out.width='75%'}
knitr::include_graphics(path = "img/bins-45-no-show-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 8% 95%
background-size: 6%

## Visualizing variable distributions across groups

### What questions do these graphs answer?

How does the distribution of `dir_request` across `trans_type`? 

--

### We can view this with a density plot, violin plot, or ridgeline plot

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Density Plots

### CREATE LABELS FIRST!! 

We need a new set of labels 

```{r labs_density}
lab_density <- labs(x = "Apple directions requests",
                    y = "Density",
     title = "Direction Requests vs. Transportation Type",
     subtitle = "source: https://covid19.apple.com/mobility")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Density Plots

Visualize the distribution of `dir_request` across `trans_type` with a `geom_density()`

```{r density, eval=FALSE}
TidyApple %>% 
  ggplot() +
  geom_density(aes(x = dir_request, #<<
                   fill = trans_type)) + #<<
  lab_density
```

```{r density-no-show, include=FALSE}
TidyApple %>% 
  ggplot() +
  geom_density(aes(x = dir_request, 
                   fill = trans_type)) + 
  lab_density
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Density Plots

```{r density-no-show-1-show, echo=FALSE, out.height='85%', out.width='85%'}
knitr::include_graphics(path = "img/density-no-show-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Density Plots (`alpha`)

<br>

Adjust the `alpha` so we can see the overlap

```{r density-alpha, eval=FALSE}
TidyApple %>% 
  ggplot() +
  geom_density(aes(x = dir_request, 
                   fill = trans_type), 
               alpha = 1/3) + #<<
  lab_density
```

```{r density-alpha-no-show, include=FALSE}
TidyApple %>% 
  ggplot() +
  geom_density(aes(x = dir_request, 
                   fill = trans_type), 
               alpha = 1/3) + 
  lab_density
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Density Plots (`alpha`)

Now we can see where they overlap

```{r density-alpha-no-show-1-show, echo=FALSE, out.height='85%', out.width='85%'}
knitr::include_graphics(path = "img/density-alpha-no-show-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Violin Plots 

Violin plots are alternatives to boxplots. 

```{r lab_violin}
lab_violin <- labs(y = "Apple directions requests",
                   x = "Transportation Types",
     title = "Direction Requests by Transportation Type",
     subtitle = "source: https://covid19.apple.com/mobility")
```

These allow us to add a categorical variable to the `x` axis. 

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Violin Plots 

```{r geom_violin-no-show, eval=FALSE}
TidyApple %>% 
  ggplot() +
  geom_violin(aes(y = dir_request, x = trans_type, #<<
                  fill = trans_type)) + #<<
  lab_violin
```

```{r geom_violin, include=FALSE}
TidyApple %>% 
  ggplot() +
  geom_violin(aes(y = dir_request, x = trans_type, #<<
                  fill = trans_type)) + #<<
  lab_violin
```


```{r geom_violin-1-show, echo=FALSE, out.height='85%', out.width='85%'}
knitr::include_graphics(path = "img/geom_violin-1.png")
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Violin Plots: *confused?*

Add a boxplot layer!

```{r geom_violin-no-run, eval=FALSE}
TidyApple %>% 
  ggplot() +
  geom_violin(aes(y = dir_request, x = trans_type, #<<
                  fill = trans_type), alpha = 1/5) #<<
```

--

```{r geom_violin-geom_boxplot-no-run, eval=FALSE}
TidyApple %>% 
  ggplot() +
  geom_violin(aes(y = dir_request, x = trans_type, 
                  fill = trans_type), alpha = 1/5) + 
  geom_boxplot(aes(y = dir_request, x = trans_type, #<<
                   color = trans_type)) + #<<
  lab_violin
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Violin Plots *and* Boxpots

```{r geom_violin-geom_boxplot-run-no-show, include=FALSE}
TidyApple %>% 
  ggplot() +
  geom_violin(aes(y = dir_request, x = trans_type, 
                  fill = trans_type), alpha = 1/5) + 
  geom_boxplot(aes(y = dir_request, x = trans_type, 
                   color = trans_type)) +
  lab_violin
```

```{r geom_violin-geom_boxplot-run-no-show-1-show, echo=FALSE, out.height='95%', out.width='95%'}
knitr::include_graphics(path = "img/geom_violin-geom_boxplot-run-no-show-1.png")
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Rideline Plots 

Another option is a ridgeline plot (from the `ggridges` package). These display multiple densities. 

```{r lab_ridges}
lab_ridges <- labs(x = "Apple directions requests",
                   y = "Transportation Types",
     title = "Direction Requests by Transportation Type",
     subtitle = "source: https://covid19.apple.com/mobility")
```

```{r ggridges, eval=FALSE}
library(ggridges)
TidyApple %>%  
  ggplot() + 
  geom_density_ridges(aes(x = dir_request, 
                          y = trans_type, 
                          fill = trans_type), 
                      alpha = 1/5) + 
  lab_ridges
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Rideline Plots 

We can adjust the alpha on these just like the density plots.

```{r geom_density_ridges-plot, echo=FALSE}
library(ggridges)
TidyApple %>%  
  ggplot() + 
  geom_density_ridges(aes(x = dir_request, 
                          y = trans_type, 
                          fill = trans_type), 
                      alpha = 1/5) + 
  lab_ridges
```

```{r geom_density_ridges-plot-1, echo=FALSE, out.height='80%', out.width='80%'}
knitr::include_graphics(path = "img/geom_density_ridges-plot-1.png")
```



---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Line Graphs

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Narrowing date ranges

Filter the data to only us cities between `2020-02-01` and `2020-08-01`. Use `skimr::skim()` to make sure it works!

--

```{r filter-us-cities, eval=FALSE}
TidyApple %>% 
  # us cities
  filter(geo_type == "city" &
         country == "United States", 
         # feb - aug
         date >= lubridate::as_date("2020-02-01") & 
         date <= lubridate::as_date("2020-08-01")) %>% 
         # check work!
         skimr::skim(date)
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Check with `skimr` output

These are helpful if we're checking a filter on a numerical certain condition (`min`, `max`, `mean`, etc.)

<br>

```{r skimr-output-png, echo=FALSE, out.height='100%', out.width='100%', fig.align='left'}
knitr::include_graphics(path = "img/skimr-output.png")
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Narrow to US Cities (Feb-Jul) 

<br>

Create `USCitiesFebJul` data by filtering to US cities between Feb 1, 2020 and July 31, 2020.

<br>

```{r USCitiesFebJul}
TidyApple %>% 
  filter(geo_type == "city" &
         country == "United States", 
         date >= lubridate::as_date("2020-02-01") & 
         date <= lubridate::as_date("2020-08-01")) -> USCitiesFebJul
```



---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graph: Labels (1)

Ideally, our labels update whenever the data changes. We can do this with `paste0()`.

```{r paste0}
paste0(min(USCitiesFebJul$date), 
                       " through ", 
                       max(USCitiesFebJul$date)) 
```

--

```{r subtitle, eval=FALSE}
 subtitle = paste0(
                    min(USCitiesFebJul$date), # first date
                    " through ", # plain text
                    max(USCitiesFebJul$date)  # last date
                    ), 
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graph: Labels (2)

<br>

We can then supply the `subtitle` to `labs`

<br><br>


```{r lab_line_graph}
labs(x = "Date",
     y = "Direction Requests",
     title = "Direction Requests Over Time (US Cities Only)",
     subtitle = paste0(min(USCitiesFebJul$date), #<<
                       " through ", #<<
                       max(USCitiesFebJul$date)), #<<
     caption = "source: https://covid19.apple.com/mobility", 
     color = "Transit Type") -> lab_line_graph
```



---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graph: Labels (3)

<br>

```{r apply-lab_line_graph-no-run, include=FALSE}
USCitiesFebJul %>% 
  ggplot() +
  geom_line(aes(x = date, 
                y = dir_request, 
                   group = trans_type, 
                   color = trans_type)) + 
    lab_line_graph
```


```{r apply-lab_line_graph-show, echo=FALSE, out.height='100%', out.width='100%', fig.align='center'}
knitr::include_graphics(path = "img/apply-lab_line_graph-show.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graphs: Overlapping Lines

Consider our previous line graph--the lines overlap a bit.

```{r apply-lab_line_graph-no-run-1-show, echo=FALSE, out.height='100%', out.width='100%', fig.align='center'}
knitr::include_graphics(path = "img/apply-lab_line_graph-no-run-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graph: Line Size (1)

We can minimize the size of the line with the `size` aesthetic.

```{r geom_line-smaller-size, eval=FALSE}
USCitiesFebJul %>% 
  ggplot() +
  geom_line(aes(x = date, y = dir_request, 
             group = trans_type, color = trans_type), 
            # make these slightly smaller
            size = 0.30) + 
  lab_line_graph
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Line Graph: Line Size (2)

This makes the trends easier to see.

```{r geom_line-smaller-size-no-show, include=FALSE}
USCitiesFebJul %>% 
  ggplot() +
  geom_line(aes(x = date, y = dir_request, 
             group = trans_type, color = trans_type), 
            # make these slightly smaller
            size = 0.30) + 
  lab_line_graph
```


```{r geom_line-smaller-size-1-show, echo=FALSE, out.height='100%', out.width='100%', fig.align='center'}
knitr::include_graphics(path =
"img/geom_line-smaller-size-no-show-1.png")
```

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Adding Text

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Labeling Missing Data 

There is a gap in the direct request data (this is [documented in the data source](https://covid19.apple.com/mobility)). 

--

> *"Data for May 11-12 is not available and will appear as blank columns in the data set."*

--

```{r missing-geom_line-smaller-size-1-show, echo=FALSE, out.height='75%', out.width='75%', fig.align='center'}
knitr::include_graphics(path =
"img/geom_line-smaller-size-no-show-1.png")
```

We should annotate this on a line graph!

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Create Annotate Data

These data are `filter`ed to US cities between March 1, 2020 to June 30, 2020.

```{r create-USCitiesMarJun-no-run, eval=FALSE}
USCitiesMarJun <-  TidyApple %>% 
  filter(geo_type == "city" & country == "United States", 
         date >= lubridate::as_date("2020-03-01") & 
         date <= lubridate::as_date("2020-07-01"))

```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Annotate Data

```{r USCitiesMarJun-no-run, eval=FALSE}
USCitiesMarJun
```

```{r USCitiesMarJun-show-no-run, echo=FALSE}
USCitiesMarJun <-  TidyApple %>% 
  filter(geo_type == "city" &
              country == "United States", 
                date >= lubridate::as_date("2020-03-01") & 
                  date <= lubridate::as_date("2020-07-01"))
rmarkdown::paged_table(
USCitiesMarJun)
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `annotate`: Build Labels 

Build our labels first!

```{r lab_annotation}
labs(x = "Date",
     y = "Direction Requests",
     title = "Spring Direction Requests (Mar-Jun) in US Cities",
     subtitle = paste0(min(USCitiesMarJun$date), #<<
                       " through ", 
                       max(USCitiesMarJun$date)), #<<
     caption = "source: https://covid19.apple.com/mobility", 
     color = "Transit Type") -> lab_annotation
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `annotate`: Build Line Graph 

Build a line graph layer (`gg_line_annotate`)

```{r gg_line_annotate}
USCitiesMarJun %>% 
    ggplot() +
    geom_line(aes(x = date, y = dir_request, 
             group = trans_type, color = trans_type), 
             size = 0.30) -> gg_line_annotate
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `annotate`: build coordinate system

Add a coordinate system layer (`gg_coord_system`)

```{r gg_coord_system}
coord_cartesian(
 xlim = c(min(USCitiesMarJun$date), 
          max(USCitiesMarJun$date)), 
 
 ylim = c(min(USCitiesMarJun$dir_request, na.rm = TRUE), 
          max(USCitiesMarJun$dir_request, na.rm = TRUE))) -> 
  gg_coord_system
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `annotate`: build line segment 

Build vertical line segment (`gg_line_segment`)

```{r gg_line_segment}
annotate(geom = "segment", 
        size = 1, 
        color = "firebrick3",
        x = lubridate::as_date("2020-05-11"), 
        xend = lubridate::as_date("2020-05-11"), 
        y = 270, 
        yend = 100) -> gg_line_segment
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### `annotate`: Build Text Annotatation 

Build text annotation (`gg_text_annotation`)

```{r gg_text_annotation}
annotate(geom = "text",
           color = "red", 
           hjust = 0.5, 
           size = 6,
           x = lubridate::as_date("2020-05-07"), 
           y = 300, 
           label = "Data not available") -> gg_text_annotation
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%


### `annotate`: Combine Layers

Now we can use the `ggplot2` syntax to combine these layers...

<br><br>

```{r build-annotation-graph, eval=FALSE}
gg_line_annotate + # line graph
  gg_coord_system + # coordinate system 
  gg_line_segment + # line annotation
  gg_text_annotation + # text annotation 
  lab_annotation # labels
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%


### `annotate`: Complete Graph

...and we see a complete graph!

```{r build-annotation-graph-show, echo=FALSE}
gg_line_annotate + # line graph
  gg_coord_system + # coordinate system 
  gg_line_segment + # line annotation
  gg_text_annotation + # text annotation 
  lab_annotation # labels
```

```{r build-annotation-graph-show-1, echo=FALSE, out.height='65%', out.width='65%', fig.align='center'}
knitr::include_graphics(path =
"img/build-annotation-graph-show-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Labeling Values (Review)

In the previous slides, we learned about labeling values with `ggrepel`.

```{r aes-sol-11-1, echo=FALSE, fig.align='center', out.height='70%', out.width='70%'}
knitr::include_graphics(path = "img/aes-sol-11-1.png")
```

Now we're going to extend this to plotting text and values on our graphs!

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Highlighting Large US Cities 

Filter `TidyApple` to the 5 largest US cities (by [population](https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population)).

```{r TopUSCities-no-show}
TopUSCities <- TidyApple %>% 
  filter(country == "United States" & 
           region %in% c("New York City","Los Angeles", 
                         "Chicago", "Houston", "Phoenix")) 
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### View `TopUSCities`

```{r view-TopUSCities, eval=FALSE}
TopUSCities
```

```{r TopUSCities-show, echo=FALSE}
TopUSCities <- TidyApple %>% 
  filter(country == "United States" & 
           region %in% c("New York City","Los Angeles", 
                         "Chicago", "Houston", "Phoenix"))
rmarkdown::paged_table(TopUSCities)
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Highlighting Peak Driving

Create a dataset with only the maximum direction request values for `"driving"` per `region`. 

```{r MaxUSCitiesDriving, eval=FALSE}
TopUSCities %>% 
  filter(trans_type == "driving") %>% 
  group_by(region) %>% 
  slice_max(dir_request) %>% 
  ungroup() -> MaxUSCitiesDriving
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## View `MaxUSCitiesDriving`

```{r view-MaxUSCitiesDriving, eval=FALSE}
MaxUSCitiesDriving
```

<br>

```{r MaxUSCitiesDriving-no-show, echo=FALSE}
TopUSCities %>% 
  filter(trans_type == "driving") %>% 
  group_by(region) %>% 
  slice_max(dir_request) %>% 
  ungroup() -> MaxUSCitiesDriving
rmarkdown::paged_table(MaxUSCitiesDriving)
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Create graph labels 

<br>

We know we want to see the max direction requests labeled, so we will update the labels for the graph.

```{r lab_line_max_drivers}
lab_line_max_drivers <- labs(
 x = "Date",
 y = "Direction Requests",
 title = "Peak Driving Direction Requests in Largest US Cities",
 subtitle = paste0(min(TopUSCities$date), 
                   " through ", 
                   max(TopUSCities$date)),
 caption = "source: https://covid19.apple.com/mobility", 
 color = "Transit Type")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Create Value Labels 

We will also use `paste0()` here to create a variable for the labels that combines the city and date. 

```{r max_driving_labels-sol-01}
MaxUSCitiesDriving <- MaxUSCitiesDriving %>% 
  mutate(max_driving_labels = paste0(region, ", ", date))
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### View Value Labels 

Take a look at the labels we've created 

```{r view-max_driving_labels, eval=FALSE}
MaxUSCitiesDriving %>% 
  select(max_driving_labels)
```

```{r max_driving_labels-show, echo=FALSE}
rmarkdown::paged_table(
MaxUSCitiesDriving %>% 
  select(max_driving_labels))
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Create Line Layer + Label Layer

```{r plot-with-labels-show, eval=FALSE}
library(ggrepel)
TopUSCities %>% 
    ggplot() + 
    geom_line(aes(x = date, y = dir_request, 
                  group = trans_type, 
                  color = trans_type), 
                  # make these slightly smaller again...
                  size = 0.15) + 
    geom_label_repel(data = MaxUSCitiesDriving,
              aes(x = date, y = dir_request, 
                  label = max_driving_labels), 
                  # set color and size...
                  color = "red", 
                  size = 3) + 
  lab_line_max_drivers
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### View plot with labels

```{r plot-with-labels-no-show, include=FALSE}
library(ggrepel)
TopUSCities %>% 
    ggplot() + 
    geom_line(aes(x = date, y = dir_request, 
                  group = trans_type, 
                  color = trans_type), 
                  # make these slightly smaller again...
                  size = 0.15) + 
    geom_label_repel(data = MaxUSCitiesDriving,
              aes(x = date, y = dir_request, 
                  label = max_driving_labels), 
                  # set color and size...
                  color = "red", 
                  size = 3) + 
  lab_line_max_drivers
```

```{r plot-with-labels-no-show-1, echo=FALSE, fig.align='center', out.height='100%', out.width='100%'}
knitr::include_graphics(path = "img/plot-with-labels-no-show-1.png")
```

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Adding Reference Lines

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Reference Line Data 

```{r ref-line-TopUSCities-no-run, eval=FALSE}
TopUSCities
```

```{r ref-line-TopUSCities-no-run-show, echo=FALSE}
rmarkdown::paged_table(TopUSCities)
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Reference Line Labels 

```{r lab_ref_lines}
labs(x = "Date", 
 y  = "Direction Requests", 
 title = "Trends of Relative Activity in Selected US Cities",
 subtitle = "New York, Los Angeles, Chicago, Houston, Phoenix",
 color = "Type") -> lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Horizontal Reference Lines

Add the `geom_hline()` for a horizontal reference line (at `100`)

```{r geom_hline-no-run, eval=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = trans_type, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, size = 0.2, color = "gray20") +
  lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Horizontal Reference Lines

```{r geom_hline-show, include=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = trans_type, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, size = 0.2, color = "gray20") +
  lab_ref_lines
```

```{r geom_hline-show-1, echo=FALSE, fig.align='center', out.height='95%', out.width='95%'}
knitr::include_graphics(path = "img/geom_hline-show-1.png")
```

---
class: inverse, center, top
background-image: url(img/ggplot2.png)
background-position: 50% 70%
background-size: 35%

# Advanced Facetting 

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Faceting basics 

Facets create subplots across levels of a categorical variable.

```{r facet_wrap-1, eval=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = trans_type, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, 
             size = 0.2, 
             color = "gray20") +
  facet_wrap(~ region,  ncol = 2) + #<<
  lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Single Variable Facets 

```{r facet_wrap-show, echo=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = trans_type, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, 
             size = 0.2, 
             color = "gray20") +
  facet_wrap(~ region,  ncol = 2) + 
  lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Multiple Variable Facets 

```{r facet_wrap-2vars-1, eval=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = region, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, 
             size = 0.2, 
             color = "gray20") +
  facet_wrap(region ~ trans_type, ncol = 5) + #<<
  lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

## Multiple Variable Facets 

```{r facet_wrap-2vars-2, echo=FALSE}
TopUSCities %>% 
  ggplot(aes(x = date, y = dir_request, 
             group = region, 
             color = trans_type)) + 
  geom_line(size = 0.1) + 
  geom_hline(yintercept = 100, size = 0.2, color = "gray20") +
  facet_wrap(region ~ trans_type, ncol = 5) + 
  lab_ref_lines
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Advanced Faceting (`facet_wrap_paginate`)

Check out the exercises for more advanced faceting with `facet_wrap_paginate()` from the `ggforce` package. 

```{r facet_wrap_paginate-sol-1-png, echo=FALSE}
knitr::include_graphics(path = "img/facet_wrap_paginate-sol-1.png")
```

---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

### Advanced Faceting (`facet_geo`)

Check out the exercises for more advanced faceting with `facet_geo()` from the `geofacet` package. 

```{r facet_geo-sol-1-png, echo=FALSE}
knitr::include_graphics(path = "img/facet_geo-sol-1.png")
```


---
class: left, top
background-image: url(img/ggplot2.png)
background-position: 95% 8%
background-size: 8%

# More Resources

### [Fundamentals of Data Visualization](https://clauswilke.com/dataviz/)

### [ggplot2 extensions gallery](https://exts.ggplot2.tidyverse.org/gallery/)

### [R Graphics Cookbook](https://r-graphics.org/)



```{r chrome_print, eval=FALSE, include=FALSE, echo=FALSE}
fs::dir_create("pdfs")
pagedown::chrome_print(input = "Index.html", 
                       output = "pdfs/data-viz-as-comm-slides.pdf")
```


```{r SPYvsSPY, eval=FALSE, echo=FALSE}
library(SPYvsSPY)
SPYvsSPY::svs %>% 
  select(yrmo, white_comeuppance, black_comeuppance)
```
